<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dickerchen</title>
  <link rel="manifest" href="/manifest.json">
  <script src="/version.js"></script>
  <script src="/backend-status.js"></script>
  <script src="/version-manager.js"></script>
  <script>
    // Apply versioning immediately after version.js loads
    document.addEventListener('DOMContentLoaded', function() {
      // Force reload CSS with version parameter
      const cssLink = document.getElementById('main-styles');
      if (cssLink && window.versionedUrl) {
        cssLink.href = window.versionedUrl('/styles.css');
      }
      
      // Also add timestamp to force cache bust
      const timestamp = Date.now();
      if (cssLink) {
        const separator = cssLink.href.includes('?') ? '&' : '?';
        cssLink.href = cssLink.href + separator + 't=' + timestamp;
      }
    });
  </script>
  <link rel="stylesheet" href="/styles.css" id="main-styles">
</head>
<body>
  <div id="app">
    <header>
      <h1>💪Dickerchen<span class="version-info" id="version-display"></span></h1>
      <div class="exercise-switcher">
        <button class="exercise-btn current-exercise" data-exercise="pushups">
          <img src="pushup_weak.png" alt="Push-ups" class="exercise-icon">
        </button>
        <button class="exercise-btn" data-exercise="squats">
          <img src="squats1_weak.png" alt="Squats" class="exercise-icon">
        </button>
        <button class="exercise-btn" data-exercise="situps">
          <img src="situps1_weak.png" alt="Sit-ups" class="exercise-icon">
        </button>
      </div>
      <h1 id="exercise-title">💪 Push-ups</h1>
      <p id="motivation">Mach deine Dicken! 🏋️‍♂️</p>
      <div id="tabs">
        <button id="tab-today" class="tab-btn active">Heute</button>
        <button id="tab-alltime" class="tab-btn">Ewige Statistik</button>
      </div>
    </header>
    <main>
      <div id="today-view" class="view active">
        <div id="dashboard">
          <div id="progress">
            <div class="progress-header">
              <h2 id="progress-title">Dein Fortschritt heute</h2>
              <div class="header-buttons">
                <button id="combined-btn" class="combined-btn" data-exercise="combined">🎯</button>
                <button id="save-progress" class="save-btn">💾</button>
                <button id="share-progress" class="share-btn" style="display: none;">📤 Teilen</button>
              </div>
            </div>
            <div id="progress-bar">
              <div id="progress-fill"></div>
              <input type="range" id="progress-slider" min="1" max="100" value="10" step="1">
              <p id="progress-text">0 / 100</p>
            </div>
          </div>
          <div id="add-pushups">
            <div class="add-buttons-row">
              <button class="add-btn" data-count="10">💪 +10</button>
              <button class="add-btn" data-count="20">💪💪 +20</button>
              <button class="add-btn" data-count="30">💪💪💪 +30</button>
            </div>
          </div>
          <div id="leaderboard">
            <h2>🏆 Leaderboard heute</h2>
            <ul id="leaderboard-list"></ul>
          </div>
        </div>
      </div>
      
      <div id="alltime-view" class="view">
        <div id="alltime-dashboard">
          <div id="total-progress" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: white;">Dein Gesamtfortschritt</h2>
            <p id="total-text" style="font-size: 18px; margin: 10px 0;">Erst 0 Dicke insgesamt 😱</p>
            <p id="yearly-potential-text" style="color: #FFE66D; font-weight: bold; margin-top: 15px; font-size: 16px; display: none;">🚀 Du kannst noch 0 Dicke erreichen!</p>
          </div>
          <div id="alltime-leaderboard">
            <h2>🏆 Ewige Bestenliste</h2>
            <ul id="alltime-leaderboard-list"></ul>
          </div>
          <div id="calendar">
            <h2>📅 Dein Kalender</h2>
            <div id="calendar-controls">
              <button id="prev-month">‹</button>
              <span id="current-month">September 2025</span>
              <button id="next-month">›</button>
            </div>
            <div id="calendar-grid"></div>
          </div>
        </div>
      </div>
      
      <!-- Modal Overlay -->
      <div id="user-modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2 id="modal-name"></h2>
          <div id="modal-progress"></div>
          <h3 id="modal-log-title">Protokoll heute:</h3>
          <ul id="modal-log"></ul>
          
          <!-- Goals Section (only shown for current user) -->
          <div id="modal-goals-section" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
            <h3>🎯 Deine persönlichen Ziele</h3>
            <div id="modal-goals-form">
              <div class="goal-input-group">
                <label>💪 Push-ups pro Tag:</label>
                <input type="number" id="goal-pushups" min="1" max="1000" />
              </div>
              <div class="goal-input-group">
                <label>🦵 Squats pro Tag:</label>
                <input type="number" id="goal-squats" min="1" max="1000" />
              </div>
              <div class="goal-input-group">
                <label>🏋️ Sit-ups pro Tag:</label>
                <input type="number" id="goal-situps" min="1" max="1000" />
              </div>
              <button id="save-goals-btn" class="save-goals-btn">💾 Ziele speichern</button>
            </div>
          </div>
          
          <button id="nudge-btn">👉 Anstupsen!</button>
          <button id="debug-btn" style="background: #666; margin-top: 10px;">🔍 Debug Info</button>
          <button id="test-notifications-btn" style="background: #ff9800; margin-top: 10px;">🔔 Test Notifications</button>
        </div>
      </div>
      
      <!-- Debug Modal -->
      <div id="debug-modal" class="modal">
        <div class="modal-content">
          <span class="close debug-close">&times;</span>
          <h2>🔍 Debug Information</h2>
          <h3>Push Subscriptions:</h3>
          <pre id="debug-subscriptions"></pre>
          <h3>Recent Logs:</h3>
          <pre id="debug-logs"></pre>
        </div>
      </div>
    </main>
  </div>
  <script>
    // Load app.js with version parameter - wait for version.js to be fully loaded
    function loadAppJS() {
      // Force aggressive cache busting with multiple parameters
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(7);
      
      if (window.versionedUrl) {
        const appScript = document.createElement('script');
        appScript.src = window.versionedUrl('/app.js') + '&t=' + timestamp + '&r=' + random;
        document.body.appendChild(appScript);
        console.log('📦 Loading app.js with version:', appScript.src);
      } else {
        // Fallback if version.js fails
        const appScript = document.createElement('script');
        appScript.src = '/app.js?t=' + timestamp + '&r=' + random;
        document.body.appendChild(appScript);
        console.log('📦 Loading app.js without version:', appScript.src);
      }
    }
    
    // Ensure version.js is loaded first
    if (window.APP_VERSION) {
      loadAppJS();
    } else {
      // Wait a bit for version.js to load
      setTimeout(loadAppJS, 100);
    }
    
    // Display version in header
    document.addEventListener('DOMContentLoaded', () => {
      const versionDisplay = document.getElementById('version-display');
      if (versionDisplay && window.APP_VERSION) {
        versionDisplay.textContent = `v${window.APP_VERSION}`;
      }
    });
  </script>
</body>
</html>
